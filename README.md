# Документация по проекту Telegram-бота для медицинских анализов

## Описание

Этот проект представляет собой Telegram-бота, который принимает документы с медицинскими анализами и исследованиями, извлекает данные из них и отвечает на вопросы пользователей на основе сохранённых данных.

## Функциональные требования

1. **Приём документов**
   - Бот должен уметь принимать документы в форматах PDF, PNG, JPEG.
   - Пользователь загружает файл с медицинскими анализами в чат с ботом.

2. **Извлечение данных**
   - Бот должен извлекать из документов следующие данные:
     - Для медицинских анализов:
       - Наименование анализа (например, "Гемоглобин", "Глюкоза").
       - Референтные значения (нормы) для анализа.
       - Единицы измерения (например, г/дл, %).
       - Результаты анализа (например, числовое значение или текст).
       - Дата проведения анализа.
       - Место проведения анализа (например, наименование медучреждения).
       - Адрес места проведения анализа.
     - Для медицинских исследований:
       - Наименование исследования (например, "Ультразвуковое исследование").
       - Дата проведения исследования.
       - Место проведения исследования (например, наименование медучреждения).
       - Аппарат, на котором проводилось исследование.
       - Протокол исследования.
       - Заключение исследования.
       - Рекомендация исследования.
       - Адрес места проведения исследования.
   - Извлечённые данные должны быть структурированы и представлены в виде списка пользователю.

3. **Сохранение данных**
   - Извлечённые данные должны быть сохранены в базе данных PostgreSQL.
   - Структура базы данных должна позволять эффективно хранить и запрашивать данные.

4. **Взаимодействие с пользователем**
   - Бот должен уметь отвечать на вопросы пользователя по загруженным медицинским анализам и исследованиям.
   - Пользователь должен иметь возможность задавать вопросы боту, например:
     - "Какие у меня были результаты по [наименование анализа]?"
     - "Покажи результаты анализов за [период времени]."
   - Бот должен корректно интерпретировать запросы пользователя и предоставлять соответствующие ответы на основе данных в базе данных.

5. **Обработка запросов**
   - Бот должен корректно извлекать и отображать информацию из базы данных на основе пользовательских запросов.
   - Ответы бота должны быть точными и содержать все запрашиваемые данные.

## Нефункциональные требования

1. **Документация**
   - Необходимо предоставить краткую документацию по архитектуре решения, включая описание структуры базы данных, используемых библиотек и API.
   - Описание процесса деплоя и запуска бота.

2. **Инструменты и технологии**
   - Telegram Bot API для создания бота.
   - Любая библиотека для обработки и извлечения текста из PDF, PNG, JPEG.
   - Любое API проприетарной большой языковой модели.
   - PostgreSQL для хранения данных.
   - Любая ORM для работы с базой данных.
   - Docker для контейнеризации решения (желательно, но необязательно).

## Ключевые метрики оценки

1. **Количество правильно извлечённых данных**
   - Процент извлечённых данных из документов, соответствующих реальным данным в анализах.
   - Корректность извлечения всех требуемых полей (наименование анализа, референтные значения, результаты, дата, место).

2. **Количество правильных ответов на вопросы пользователя**
   - Точность и полнота ответов бота на запросы пользователей.
   - Способность бота интерпретировать различные формулировки запросов.

3. **Производительность**
   - Время обработки документов и генерации ответов на запросы пользователя.

## Архитектура решения

### Файлы проекта

- **`bot.py`**: Основной файл, который обрабатывает вебхуки от Telegram, загружает файлы, извлекает текст и взаимодействует с моделью GPT-4.

- **`llm.py`**: Модуль для взаимодействия с API OpenAI для получения ответов от модели GPT-4.

- **`text_extraction.py`**: Модуль для извлечения текста из PDF и изображений.

- **`models.py`**: Определяет структуру базы данных с помощью SQLAlchemy.

- **`db_setup.py`**: Настройка подключения к базе данных и создание сессий.

### База данных

Структура базы данных PostgreSQL включает две основные таблицы:

- **`users`**: Таблица пользователей, содержащая информацию о пользователе (ID, имя, фамилия, никнейм).

- **`files`**: Таблица файлов, содержащая информацию о загруженных файлах (ID, ID пользователя, имя файла, тип файла, содержание).

### Процесс деплоя

1. **Настройка окружения**
   - Установите необходимые зависимости.
   - Настройте переменные окружения (например, `TOKEN`, `OPENAI_API_KEY`, `DATABASE_URL`).

2. **Запуск приложения**
   - Запустите Flask сервер с помощью команды `python bot.py`.
   - Настройте вебхук Telegram с помощью эндпоинта `/set-webhook`.

## Примечания

- Убедитесь, что все переменные окружения настроены правильно.
- Проверьте, что все зависимости установлены.
- Для обработки изображений требуется установленный Tesseract-OCR.
- Бот не запоминает предыдущие взаимодействия и может предоставить ответ только на основе информации, содержащейся в загруженных документах.
- В случае превышения допустимого объема файловой информации, бот не сможет обработать запросы.